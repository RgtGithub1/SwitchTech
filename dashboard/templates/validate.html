{% include  'base_login_validate.html' %}
{% load static %}
{% block content %}

<!-- testing_otp_code -->
<!DOCTYPE html>
<html lang="en">

<head>
    <link href="{% static 'css/login.css' %}" rel="stylesheet">
    <style>
        .footer {
        background-color: #343a40; 
        color: white; 
        padding: 10px 0;
        text-align: center;
        width: 100%;
        height: 49px;
        z-index: 1000;
    }
</style>

</head>

<body>
    <div class="container" style="margin-top: 120px;">
        <div class="row">
            <div class="col-md-6" style="margin-top: 60px;">
                <div class="email_main_form">

                    <form method="POST" action="{% url 'dashboard:validate' %}">

                        <p class="header_desc">
                            <h4 >Please check your mail, you will recevie four digit OTP enter below to continue...</h4>
                            <h4>If not received, <a href="#" id="resend-link" onclick="resendOTP()">click here</a> to resend OTP</h4>
                            <div id="resend-message" style="color: green;"></div>
                        </p>

                        {% csrf_token %}

                        <div class="form-group pt-1">

                            <!-- //its take automatically which your mentioned in login mail -->

                            <label for="fname">Employee mail:</label>

                            <input id="mail" type="text" name="mail" placeholder="RGT EMAIL ID" readonly
                                onkeydown="handleEnterKey(event)">

                        </div>

                        <!-- //here enter otp  -->

                        <div class="form-group">

                            <label for="fname">OTP:</label>

                            <input id="otp-input" type="text" name="otp" required oninput="hideErrorMessage()">

                        </div>

                        <!-- // it is dispaly a error message -->

                        {% if messages %}
                        <ul id="error-message" class="messages" style="color: red; margin-top: 10px;">
                            {% for message in messages %}
                                {{message}}
                            {% endfor %}
                        </ul>
                        {% endif %}

                        <!-- //if the user is click on keep signed option next onwards  -->

                        <div class="form-group">

                            <label for="keep-signed-in">

                                <input id="keep-signed-in pt-3" type="checkbox" name="remember_me">

                                Keep me signed in

                            </label>

                        </div>

                        <!-- // its valid otp -->

                        <input class="pt-3" type="submit" value="Validate OTP">

                    </form>
                </div>
            </div>
            <div class="col-md-6" style=" margin-top: 16px;">
                <img class="img-thumbnail rounded logo" style="top: 48px;"   src="{% static 'images/loginimg.png' %}" width="100%" />
            </div>
        </div>
    </div>
    
 <div class="footer">
        &copy; 2023 SwitchTech. All rights reserved.
    </div>

    <script>
            //hide the error message
            function hideErrorMessage() {
                var errorMessage = document.getElementById("error-message");
                errorMessage.style.display = "none";
            }
    
            document.getElementById("mail").value = localStorage.getItem("email");
    
            function handleEnterKey(event) {
                if (event.keyCode === 13) {
                    event.preventDefault(); // Prevent form submission
                    // Get the index of the current input field
                    var currentIndex = Array.from(document.querySelectorAll('input')).indexOf(event.target);
                    // Find the next input field
                    var inputs = document.querySelectorAll('input');
                    var nextInput = inputs[currentIndex + 1];
                    if (nextInput) {
                        nextInput.focus(); // Move focus to the next input field
                    }
                }
            }
    
            function getCookie(name) {
              // Function to retrieve a specific cookie by name
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === name + '=') {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                  }
                }
              }
              return cookieValue;
            }
    
            let resendLinkClicked = false;
    
            // Function to disable the "Resend OTP" link for 15 seconds
            function disableResendLink() {
                const resendLink = document.getElementById('resend-link');
                resendLink.style.pointerEvents = 'none'; // Disable click events
                resendLink.style.color = 'gray'; // Gray out the link text
                setTimeout(function () {
                    enableResendLink();
                }, 15000); // 15 seconds
            }
    
            // Function to enable the "Resend OTP" link
            function enableResendLink() {
                const resendLink = document.getElementById('resend-link');
                resendLink.style.pointerEvents = 'auto'; // Enable click events
                resendLink.style.color = ''; // Restore the link text color
            }
    
            function resendOTP() {
                if (resendLinkClicked) {
                    return; // Do nothing if the link has already been clicked
                }
    
                const csrfToken = getCookie('csrftoken');
                if (!csrfToken) {
                    console.error('CSRF token not found. Make sure the CSRF middleware is enabled.');
                    return;
                }
    
                // Call the disableResendLink() function to disable the link
                disableResendLink();
    
                fetch('/resend_otp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({}),
                })
                .then(response => {
                    if (response.ok) {
                        console.log('OTP Resent successfully!');
                        document.getElementById('resend-message').innerText = 'New OTP has been sent to your email.';
                    } else {
                        console.error('Failed to resend OTP.');
                    }
                    // Set resendLinkClicked to false after the request completes
                    resendLinkClicked = false;
                })
                .catch(error => {
                    console.error('Error occurred during the request:', error);
                    // Set resendLinkClicked to false if an error occurs
                    resendLinkClicked = false;
                });
    
                // Set resendLinkClicked to true when the link is clicked
                resendLinkClicked = true;
            }
    
    </script>
     <script type="text/javascript">
        function preback() {
          window.history.forward();
        }
        setTimeout("preback()", 0);
        window.onunload=function() {null};
    </script>
</body>
</html>

{% endblock %}